import _extends from "@babel/runtime/helpers/esm/extends";
import _objectWithoutProperties from "@babel/runtime/helpers/esm/objectWithoutProperties";
import _classCallCheck from "@babel/runtime/helpers/esm/classCallCheck";
import _createClass from "@babel/runtime/helpers/esm/createClass";
import _possibleConstructorReturn from "@babel/runtime/helpers/esm/possibleConstructorReturn";
import _getPrototypeOf from "@babel/runtime/helpers/esm/getPrototypeOf";
import _inherits from "@babel/runtime/helpers/esm/inherits";
import _assertThisInitialized from "@babel/runtime/helpers/esm/assertThisInitialized";
import _defineProperty from "@babel/runtime/helpers/esm/defineProperty";
import React, { PureComponent } from 'react';
import PropTypes from 'prop-types';
import fuzzaldrin from 'fuzzaldrin-plus';
import VirtualList from 'react-tiny-virtual-list';
import { Pane } from '../../layers';
import { TableHead, SearchTableHeaderCell } from '../../table';
import OptionShapePropType from './OptionShapePropType';
import Option from './Option';
/**
 * Fuzzaldrin-plus is the default filter, but you can use your own
 * as long as they follow the following signature:
 * @param options <Array[String]> - ['label', 'label2', ...]
 * @param input <String>
 */

var fuzzyFilter = function fuzzyFilter(options, input) {
  return fuzzaldrin.filter(options, input);
};
/**
 * This is the default item renderer of options
 * you can pass custom renderers as long as they work the same as the Option
 */


var itemRenderer = function itemRenderer(props) {
  return React.createElement(Option, props);
};

itemRenderer.displayName = "itemRenderer";

var OptionsList =
/*#__PURE__*/
function (_PureComponent) {
  _inherits(OptionsList, _PureComponent);

  function OptionsList(props, context) {
    var _this;

    _classCallCheck(this, OptionsList);

    _this = _possibleConstructorReturn(this, _getPrototypeOf(OptionsList).call(this, props, context));

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "isSelected", function (item) {
      var selected = _this.state.selected;
      return Boolean(selected.find(function (selectedItem) {
        return selectedItem === item.value;
      }));
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "search", function (options) {
      var optionsFilter = _this.props.optionsFilter;
      var searchValue = _this.state.searchValue;
      return searchValue.trim() === '' ? options // Return if no search query
      : optionsFilter(options.map(function (item) {
        return item.labelInList || item.label;
      }), searchValue).map(function (name) {
        return options.find(function (item) {
          return item.labelInList === name || item.label === name;
        });
      });
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "getCurrentIndex", function () {
      var selected = _this.props.selected;

      var options = _this.getFilteredOptions();

      return options.findIndex(function (option) {
        return option.value === selected[selected.length - 1];
      });
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "handleKeyDown", function (e) {
      if (e.keyCode === 38) {
        _this.handleArrowUp();
      }

      if (e.keyCode === 40) {
        _this.handleArrowDown();
      }

      if (e.keyCode === 13) {
        _this.handleEnter();
      }
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "handleArrowUp", function () {
      var onSelect = _this.props.onSelect;

      var options = _this.getFilteredOptions();

      var nextIndex = _this.getCurrentIndex() - 1;

      if (nextIndex < 0) {
        nextIndex = options.length - 1;
      }

      onSelect(options[nextIndex]);
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "handleArrowDown", function () {
      var onSelect = _this.props.onSelect;

      var options = _this.getFilteredOptions();

      var nextIndex = _this.getCurrentIndex() + 1;

      if (nextIndex === options.length) {
        nextIndex = 0;
      }

      onSelect(options[nextIndex]);
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "handleEnter", function () {
      var isSelected = _this.getCurrentIndex() !== -1;

      if (isSelected) {
        _this.props.close();
      }
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "handleChange", function (searchValue) {
      _this.setState({
        searchValue: searchValue
      });

      _this.props.onFilterChange(searchValue);
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "handleSelect", function (item) {
      _this.props.onSelect(item);
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "handleDeselect", function (item) {
      _this.props.onDeselect(item);
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "assignSearchRef", function (ref) {
      _this.searchRef = ref;
    });

    _this.state = {
      searchValue: props.defaultSearchValue,
      selected: props.selected
    };
    return _this;
  }

  _createClass(OptionsList, [{
    key: "componentDidMount",
    value: function componentDidMount() {
      var _this2 = this;

      var hasFilter = this.props.hasFilter;
      if (!hasFilter) return;
      /**
       * Hacky solution for broken autoFocus
       * https://github.com/segmentio/evergreen/issues/90
       */

      requestAnimationFrame(function () {
        _this2.searchRef.querySelector('input').focus();
      });
      window.addEventListener('keydown', this.handleKeyDown);
    }
  }, {
    key: "componentWillUnmount",
    value: function componentWillUnmount() {
      window.removeEventListener('keydown', this.handleKeyDown);
    }
  }, {
    key: "componentDidUpdate",
    value: function componentDidUpdate(prevProps) {
      if (prevProps.selected !== this.props.selected) {
        // eslint-disable-next-line react/no-did-update-set-state
        this.setState({
          selected: this.props.selected
        });
      }
    }
  }, {
    key: "getFilteredOptions",
    value: function getFilteredOptions() {
      var options = this.props.options;
      return this.search(options);
    }
  }, {
    key: "render",
    value: function render() {
      var _this3 = this;

      var _this$props = this.props,
          originalOptions = _this$props.options,
          close = _this$props.close,
          width = _this$props.width,
          height = _this$props.height,
          onSelect = _this$props.onSelect,
          onDeselect = _this$props.onDeselect,
          onFilterChange = _this$props.onFilterChange,
          selected = _this$props.selected,
          hasFilter = _this$props.hasFilter,
          filterPlaceholder = _this$props.filterPlaceholder,
          filterIcon = _this$props.filterIcon,
          optionSize = _this$props.optionSize,
          _renderItem = _this$props.renderItem,
          optionsFilter = _this$props.optionsFilter,
          isMultiSelect = _this$props.isMultiSelect,
          defaultSearchValue = _this$props.defaultSearchValue,
          props = _objectWithoutProperties(_this$props, ["options", "close", "width", "height", "onSelect", "onDeselect", "onFilterChange", "selected", "hasFilter", "filterPlaceholder", "filterIcon", "optionSize", "renderItem", "optionsFilter", "isMultiSelect", "defaultSearchValue"]);

      var options = this.search(originalOptions);
      var listHeight = height - (hasFilter ? 32 : 0);
      var currentIndex = this.getCurrentIndex();
      var scrollToIndex = currentIndex === -1 ? 0 : currentIndex;
      return React.createElement(Pane, _extends({
        height: height,
        width: width,
        display: "flex",
        flexDirection: "column"
      }, props), hasFilter && React.createElement(TableHead, null, React.createElement(SearchTableHeaderCell, {
        onChange: this.handleChange,
        innerRef: this.assignSearchRef,
        borderRight: null,
        height: 32,
        placeholder: filterPlaceholder,
        icon: filterIcon
      })), React.createElement(Pane, {
        flex: 1
      }, React.createElement(VirtualList, _extends({
        height: listHeight,
        width: "100%",
        itemSize: optionSize,
        itemCount: options.length,
        overscanCount: 20,
        scrollToAlignment: "auto"
      }, scrollToIndex ? {
        scrollToIndex: scrollToIndex
      } : {}, {
        renderItem: function renderItem(_ref) {
          var index = _ref.index,
              style = _ref.style;
          var item = options[index];

          var isSelected = _this3.isSelected(item);

          return _renderItem({
            key: item.value,
            label: item.label,
            style: style,
            height: optionSize,
            onSelect: function onSelect() {
              return _this3.handleSelect(item);
            },
            onDeselect: function onDeselect() {
              return _this3.handleDeselect(item);
            },
            isSelectable: !isSelected || isMultiSelect,
            isSelected: isSelected,
            disabled: item.disabled
          });
        }
      }))));
    }
  }]);

  return OptionsList;
}(PureComponent);

OptionsList.displayName = "OptionsList";

_defineProperty(OptionsList, "propTypes", {
  options: PropTypes.arrayOf(OptionShapePropType),
  close: PropTypes.func,
  height: PropTypes.number,
  width: PropTypes.number,

  /**
   * When true, multi select is accounted for.
   */
  isMultiSelect: PropTypes.bool,

  /**
   * This holds the values of the options
   */
  selected: PropTypes.arrayOf(PropTypes.string),
  onSelect: PropTypes.func,
  onDeselect: PropTypes.func,
  onFilterChange: PropTypes.func,
  hasFilter: PropTypes.bool,
  optionSize: PropTypes.number,
  renderItem: PropTypes.func,
  filterPlaceholder: PropTypes.string,
  filterIcon: PropTypes.string,
  optionsFilter: PropTypes.func,
  defaultSearchValue: PropTypes.string
});

_defineProperty(OptionsList, "defaultProps", {
  options: [],

  /**
   * Including border bottom
   * For some reason passing height to TableRow doesn't work
   * TODO: fix hacky solution
   */
  optionSize: 33,
  onSelect: function onSelect() {},
  onDeselect: function onDeselect() {},
  onFilterChange: function onFilterChange() {},
  selected: [],
  renderItem: itemRenderer,
  optionsFilter: fuzzyFilter,
  filterPlaceholder: 'Filter...',
  filterIcon: 'search',
  defaultSearchValue: ''
});

export { OptionsList as default };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZWxlY3QtbWVudS9zcmMvT3B0aW9uc0xpc3QuanMiXSwibmFtZXMiOlsiUmVhY3QiLCJQdXJlQ29tcG9uZW50IiwiUHJvcFR5cGVzIiwiZnV6emFsZHJpbiIsIlZpcnR1YWxMaXN0IiwiUGFuZSIsIlRhYmxlSGVhZCIsIlNlYXJjaFRhYmxlSGVhZGVyQ2VsbCIsIk9wdGlvblNoYXBlUHJvcFR5cGUiLCJPcHRpb24iLCJmdXp6eUZpbHRlciIsIm9wdGlvbnMiLCJpbnB1dCIsImZpbHRlciIsIml0ZW1SZW5kZXJlciIsInByb3BzIiwiT3B0aW9uc0xpc3QiLCJjb250ZXh0IiwiaXRlbSIsInNlbGVjdGVkIiwic3RhdGUiLCJCb29sZWFuIiwiZmluZCIsInNlbGVjdGVkSXRlbSIsInZhbHVlIiwib3B0aW9uc0ZpbHRlciIsInNlYXJjaFZhbHVlIiwidHJpbSIsIm1hcCIsImxhYmVsSW5MaXN0IiwibGFiZWwiLCJuYW1lIiwiZ2V0RmlsdGVyZWRPcHRpb25zIiwiZmluZEluZGV4Iiwib3B0aW9uIiwibGVuZ3RoIiwiZSIsImtleUNvZGUiLCJoYW5kbGVBcnJvd1VwIiwiaGFuZGxlQXJyb3dEb3duIiwiaGFuZGxlRW50ZXIiLCJvblNlbGVjdCIsIm5leHRJbmRleCIsImdldEN1cnJlbnRJbmRleCIsImlzU2VsZWN0ZWQiLCJjbG9zZSIsInNldFN0YXRlIiwib25GaWx0ZXJDaGFuZ2UiLCJvbkRlc2VsZWN0IiwicmVmIiwic2VhcmNoUmVmIiwiZGVmYXVsdFNlYXJjaFZhbHVlIiwiaGFzRmlsdGVyIiwicmVxdWVzdEFuaW1hdGlvbkZyYW1lIiwicXVlcnlTZWxlY3RvciIsImZvY3VzIiwid2luZG93IiwiYWRkRXZlbnRMaXN0ZW5lciIsImhhbmRsZUtleURvd24iLCJyZW1vdmVFdmVudExpc3RlbmVyIiwicHJldlByb3BzIiwic2VhcmNoIiwib3JpZ2luYWxPcHRpb25zIiwid2lkdGgiLCJoZWlnaHQiLCJmaWx0ZXJQbGFjZWhvbGRlciIsImZpbHRlckljb24iLCJvcHRpb25TaXplIiwicmVuZGVySXRlbSIsImlzTXVsdGlTZWxlY3QiLCJsaXN0SGVpZ2h0IiwiY3VycmVudEluZGV4Iiwic2Nyb2xsVG9JbmRleCIsImhhbmRsZUNoYW5nZSIsImFzc2lnblNlYXJjaFJlZiIsImluZGV4Iiwic3R5bGUiLCJrZXkiLCJoYW5kbGVTZWxlY3QiLCJoYW5kbGVEZXNlbGVjdCIsImlzU2VsZWN0YWJsZSIsImRpc2FibGVkIiwiYXJyYXlPZiIsImZ1bmMiLCJudW1iZXIiLCJib29sIiwic3RyaW5nIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSxPQUFPQSxLQUFQLElBQWdCQyxhQUFoQixRQUFxQyxPQUFyQztBQUNBLE9BQU9DLFNBQVAsTUFBc0IsWUFBdEI7QUFDQSxPQUFPQyxVQUFQLE1BQXVCLGlCQUF2QjtBQUNBLE9BQU9DLFdBQVAsTUFBd0IseUJBQXhCO0FBQ0EsU0FBU0MsSUFBVCxRQUFxQixjQUFyQjtBQUNBLFNBQVNDLFNBQVQsRUFBb0JDLHFCQUFwQixRQUFpRCxhQUFqRDtBQUNBLE9BQU9DLG1CQUFQLE1BQWdDLHVCQUFoQztBQUNBLE9BQU9DLE1BQVAsTUFBbUIsVUFBbkI7QUFFQTs7Ozs7OztBQU1BLElBQU1DLFdBQVcsR0FBRyxTQUFkQSxXQUFjLENBQUNDLE9BQUQsRUFBVUMsS0FBVjtBQUFBLFNBQW9CVCxVQUFVLENBQUNVLE1BQVgsQ0FBa0JGLE9BQWxCLEVBQTJCQyxLQUEzQixDQUFwQjtBQUFBLENBQXBCO0FBRUE7Ozs7OztBQUlBLElBQU1FLFlBQVksR0FBRyxTQUFmQSxZQUFlLENBQUFDLEtBQUs7QUFBQSxTQUFJLG9CQUFDLE1BQUQsRUFBWUEsS0FBWixDQUFKO0FBQUEsQ0FBMUI7O0FBQU1ELFk7O0lBRWVFLFc7Ozs7O0FBK0NuQix1QkFBWUQsS0FBWixFQUFtQkUsT0FBbkIsRUFBNEI7QUFBQTs7QUFBQTs7QUFDMUIscUZBQU1GLEtBQU4sRUFBYUUsT0FBYjs7QUFEMEIseUZBb0NmLFVBQUFDLElBQUksRUFBSTtBQUFBLFVBQ1hDLFFBRFcsR0FDRSxNQUFLQyxLQURQLENBQ1hELFFBRFc7QUFHbkIsYUFBT0UsT0FBTyxDQUFDRixRQUFRLENBQUNHLElBQVQsQ0FBYyxVQUFBQyxZQUFZO0FBQUEsZUFBSUEsWUFBWSxLQUFLTCxJQUFJLENBQUNNLEtBQTFCO0FBQUEsT0FBMUIsQ0FBRCxDQUFkO0FBQ0QsS0F4QzJCOztBQUFBLHFGQTBDbkIsVUFBQWIsT0FBTyxFQUFJO0FBQUEsVUFDVmMsYUFEVSxHQUNRLE1BQUtWLEtBRGIsQ0FDVlUsYUFEVTtBQUFBLFVBRVZDLFdBRlUsR0FFTSxNQUFLTixLQUZYLENBRVZNLFdBRlU7QUFJbEIsYUFBT0EsV0FBVyxDQUFDQyxJQUFaLE9BQXVCLEVBQXZCLEdBQ0hoQixPQURHLENBQ0s7QUFETCxRQUVIYyxhQUFhLENBQ1hkLE9BQU8sQ0FBQ2lCLEdBQVIsQ0FBWSxVQUFBVixJQUFJO0FBQUEsZUFBSUEsSUFBSSxDQUFDVyxXQUFMLElBQW9CWCxJQUFJLENBQUNZLEtBQTdCO0FBQUEsT0FBaEIsQ0FEVyxFQUVYSixXQUZXLENBQWIsQ0FHRUUsR0FIRixDQUdNLFVBQUFHLElBQUk7QUFBQSxlQUNScEIsT0FBTyxDQUFDVyxJQUFSLENBQWEsVUFBQUosSUFBSTtBQUFBLGlCQUFJQSxJQUFJLENBQUNXLFdBQUwsS0FBcUJFLElBQXJCLElBQTZCYixJQUFJLENBQUNZLEtBQUwsS0FBZUMsSUFBaEQ7QUFBQSxTQUFqQixDQURRO0FBQUEsT0FIVixDQUZKO0FBUUQsS0F0RDJCOztBQUFBLDhGQXdEVixZQUFNO0FBQUEsVUFDZFosUUFEYyxHQUNELE1BQUtKLEtBREosQ0FDZEksUUFEYzs7QUFFdEIsVUFBTVIsT0FBTyxHQUFHLE1BQUtxQixrQkFBTCxFQUFoQjs7QUFFQSxhQUFPckIsT0FBTyxDQUFDc0IsU0FBUixDQUNMLFVBQUFDLE1BQU07QUFBQSxlQUFJQSxNQUFNLENBQUNWLEtBQVAsS0FBaUJMLFFBQVEsQ0FBQ0EsUUFBUSxDQUFDZ0IsTUFBVCxHQUFrQixDQUFuQixDQUE3QjtBQUFBLE9BREQsQ0FBUDtBQUdELEtBL0QyQjs7QUFBQSw0RkF1RVosVUFBQUMsQ0FBQyxFQUFJO0FBQ25CLFVBQUlBLENBQUMsQ0FBQ0MsT0FBRixLQUFjLEVBQWxCLEVBQXNCO0FBQ3BCLGNBQUtDLGFBQUw7QUFDRDs7QUFFRCxVQUFJRixDQUFDLENBQUNDLE9BQUYsS0FBYyxFQUFsQixFQUFzQjtBQUNwQixjQUFLRSxlQUFMO0FBQ0Q7O0FBRUQsVUFBSUgsQ0FBQyxDQUFDQyxPQUFGLEtBQWMsRUFBbEIsRUFBc0I7QUFDcEIsY0FBS0csV0FBTDtBQUNEO0FBQ0YsS0FuRjJCOztBQUFBLDRGQXFGWixZQUFNO0FBQUEsVUFDWkMsUUFEWSxHQUNDLE1BQUsxQixLQUROLENBQ1owQixRQURZOztBQUVwQixVQUFNOUIsT0FBTyxHQUFHLE1BQUtxQixrQkFBTCxFQUFoQjs7QUFFQSxVQUFJVSxTQUFTLEdBQUcsTUFBS0MsZUFBTCxLQUF5QixDQUF6Qzs7QUFFQSxVQUFJRCxTQUFTLEdBQUcsQ0FBaEIsRUFBbUI7QUFDakJBLFFBQUFBLFNBQVMsR0FBRy9CLE9BQU8sQ0FBQ3dCLE1BQVIsR0FBaUIsQ0FBN0I7QUFDRDs7QUFFRE0sTUFBQUEsUUFBUSxDQUFDOUIsT0FBTyxDQUFDK0IsU0FBRCxDQUFSLENBQVI7QUFDRCxLQWhHMkI7O0FBQUEsOEZBa0dWLFlBQU07QUFBQSxVQUNkRCxRQURjLEdBQ0QsTUFBSzFCLEtBREosQ0FDZDBCLFFBRGM7O0FBRXRCLFVBQU05QixPQUFPLEdBQUcsTUFBS3FCLGtCQUFMLEVBQWhCOztBQUVBLFVBQUlVLFNBQVMsR0FBRyxNQUFLQyxlQUFMLEtBQXlCLENBQXpDOztBQUVBLFVBQUlELFNBQVMsS0FBSy9CLE9BQU8sQ0FBQ3dCLE1BQTFCLEVBQWtDO0FBQ2hDTyxRQUFBQSxTQUFTLEdBQUcsQ0FBWjtBQUNEOztBQUVERCxNQUFBQSxRQUFRLENBQUM5QixPQUFPLENBQUMrQixTQUFELENBQVIsQ0FBUjtBQUNELEtBN0cyQjs7QUFBQSwwRkErR2QsWUFBTTtBQUNsQixVQUFNRSxVQUFVLEdBQUcsTUFBS0QsZUFBTCxPQUEyQixDQUFDLENBQS9DOztBQUVBLFVBQUlDLFVBQUosRUFBZ0I7QUFDZCxjQUFLN0IsS0FBTCxDQUFXOEIsS0FBWDtBQUNEO0FBQ0YsS0FySDJCOztBQUFBLDJGQXVIYixVQUFBbkIsV0FBVyxFQUFJO0FBQzVCLFlBQUtvQixRQUFMLENBQWM7QUFDWnBCLFFBQUFBLFdBQVcsRUFBWEE7QUFEWSxPQUFkOztBQUdBLFlBQUtYLEtBQUwsQ0FBV2dDLGNBQVgsQ0FBMEJyQixXQUExQjtBQUNELEtBNUgyQjs7QUFBQSwyRkE4SGIsVUFBQVIsSUFBSSxFQUFJO0FBQ3JCLFlBQUtILEtBQUwsQ0FBVzBCLFFBQVgsQ0FBb0J2QixJQUFwQjtBQUNELEtBaEkyQjs7QUFBQSw2RkFrSVgsVUFBQUEsSUFBSSxFQUFJO0FBQ3ZCLFlBQUtILEtBQUwsQ0FBV2lDLFVBQVgsQ0FBc0I5QixJQUF0QjtBQUNELEtBcEkyQjs7QUFBQSw4RkFzSVYsVUFBQStCLEdBQUcsRUFBSTtBQUN2QixZQUFLQyxTQUFMLEdBQWlCRCxHQUFqQjtBQUNELEtBeEkyQjs7QUFHMUIsVUFBSzdCLEtBQUwsR0FBYTtBQUNYTSxNQUFBQSxXQUFXLEVBQUVYLEtBQUssQ0FBQ29DLGtCQURSO0FBRVhoQyxNQUFBQSxRQUFRLEVBQUVKLEtBQUssQ0FBQ0k7QUFGTCxLQUFiO0FBSDBCO0FBTzNCOzs7O3dDQUVtQjtBQUFBOztBQUFBLFVBQ1ZpQyxTQURVLEdBQ0ksS0FBS3JDLEtBRFQsQ0FDVnFDLFNBRFU7QUFFbEIsVUFBSSxDQUFDQSxTQUFMLEVBQWdCO0FBQ2hCOzs7OztBQUlBQyxNQUFBQSxxQkFBcUIsQ0FBQyxZQUFNO0FBQzFCLFFBQUEsTUFBSSxDQUFDSCxTQUFMLENBQWVJLGFBQWYsQ0FBNkIsT0FBN0IsRUFBc0NDLEtBQXRDO0FBQ0QsT0FGb0IsQ0FBckI7QUFJQUMsTUFBQUEsTUFBTSxDQUFDQyxnQkFBUCxDQUF3QixTQUF4QixFQUFtQyxLQUFLQyxhQUF4QztBQUNEOzs7MkNBRXNCO0FBQ3JCRixNQUFBQSxNQUFNLENBQUNHLG1CQUFQLENBQTJCLFNBQTNCLEVBQXNDLEtBQUtELGFBQTNDO0FBQ0Q7Ozt1Q0FFa0JFLFMsRUFBVztBQUM1QixVQUFJQSxTQUFTLENBQUN6QyxRQUFWLEtBQXVCLEtBQUtKLEtBQUwsQ0FBV0ksUUFBdEMsRUFBZ0Q7QUFDOUM7QUFDQSxhQUFLMkIsUUFBTCxDQUFjO0FBQ1ozQixVQUFBQSxRQUFRLEVBQUUsS0FBS0osS0FBTCxDQUFXSTtBQURULFNBQWQ7QUFHRDtBQUNGOzs7eUNBK0JvQjtBQUFBLFVBQ1hSLE9BRFcsR0FDQyxLQUFLSSxLQUROLENBQ1hKLE9BRFc7QUFHbkIsYUFBTyxLQUFLa0QsTUFBTCxDQUFZbEQsT0FBWixDQUFQO0FBQ0Q7Ozs2QkFxRVE7QUFBQTs7QUFBQSx3QkFtQkgsS0FBS0ksS0FuQkY7QUFBQSxVQUVJK0MsZUFGSixlQUVMbkQsT0FGSztBQUFBLFVBR0xrQyxLQUhLLGVBR0xBLEtBSEs7QUFBQSxVQUlMa0IsS0FKSyxlQUlMQSxLQUpLO0FBQUEsVUFLTEMsTUFMSyxlQUtMQSxNQUxLO0FBQUEsVUFNTHZCLFFBTkssZUFNTEEsUUFOSztBQUFBLFVBT0xPLFVBUEssZUFPTEEsVUFQSztBQUFBLFVBUUxELGNBUkssZUFRTEEsY0FSSztBQUFBLFVBU0w1QixRQVRLLGVBU0xBLFFBVEs7QUFBQSxVQVVMaUMsU0FWSyxlQVVMQSxTQVZLO0FBQUEsVUFXTGEsaUJBWEssZUFXTEEsaUJBWEs7QUFBQSxVQVlMQyxVQVpLLGVBWUxBLFVBWks7QUFBQSxVQWFMQyxVQWJLLGVBYUxBLFVBYks7QUFBQSxVQWNMQyxXQWRLLGVBY0xBLFVBZEs7QUFBQSxVQWVMM0MsYUFmSyxlQWVMQSxhQWZLO0FBQUEsVUFnQkw0QyxhQWhCSyxlQWdCTEEsYUFoQks7QUFBQSxVQWlCTGxCLGtCQWpCSyxlQWlCTEEsa0JBakJLO0FBQUEsVUFrQkZwQyxLQWxCRTs7QUFvQlAsVUFBTUosT0FBTyxHQUFHLEtBQUtrRCxNQUFMLENBQVlDLGVBQVosQ0FBaEI7QUFDQSxVQUFNUSxVQUFVLEdBQUdOLE1BQU0sSUFBSVosU0FBUyxHQUFHLEVBQUgsR0FBUSxDQUFyQixDQUF6QjtBQUNBLFVBQU1tQixZQUFZLEdBQUcsS0FBSzVCLGVBQUwsRUFBckI7QUFDQSxVQUFNNkIsYUFBYSxHQUFHRCxZQUFZLEtBQUssQ0FBQyxDQUFsQixHQUFzQixDQUF0QixHQUEwQkEsWUFBaEQ7QUFFQSxhQUNFLG9CQUFDLElBQUQ7QUFDRSxRQUFBLE1BQU0sRUFBRVAsTUFEVjtBQUVFLFFBQUEsS0FBSyxFQUFFRCxLQUZUO0FBR0UsUUFBQSxPQUFPLEVBQUMsTUFIVjtBQUlFLFFBQUEsYUFBYSxFQUFDO0FBSmhCLFNBS01oRCxLQUxOLEdBT0dxQyxTQUFTLElBQ1Isb0JBQUMsU0FBRCxRQUNFLG9CQUFDLHFCQUFEO0FBQ0UsUUFBQSxRQUFRLEVBQUUsS0FBS3FCLFlBRGpCO0FBRUUsUUFBQSxRQUFRLEVBQUUsS0FBS0MsZUFGakI7QUFHRSxRQUFBLFdBQVcsRUFBRSxJQUhmO0FBSUUsUUFBQSxNQUFNLEVBQUUsRUFKVjtBQUtFLFFBQUEsV0FBVyxFQUFFVCxpQkFMZjtBQU1FLFFBQUEsSUFBSSxFQUFFQztBQU5SLFFBREYsQ0FSSixFQW1CRSxvQkFBQyxJQUFEO0FBQU0sUUFBQSxJQUFJLEVBQUU7QUFBWixTQUNFLG9CQUFDLFdBQUQ7QUFDRSxRQUFBLE1BQU0sRUFBRUksVUFEVjtBQUVFLFFBQUEsS0FBSyxFQUFDLE1BRlI7QUFHRSxRQUFBLFFBQVEsRUFBRUgsVUFIWjtBQUlFLFFBQUEsU0FBUyxFQUFFeEQsT0FBTyxDQUFDd0IsTUFKckI7QUFLRSxRQUFBLGFBQWEsRUFBRSxFQUxqQjtBQU1FLFFBQUEsaUJBQWlCLEVBQUM7QUFOcEIsU0FPT3FDLGFBQWEsR0FDZDtBQUNFQSxRQUFBQSxhQUFhLEVBQWJBO0FBREYsT0FEYyxHQUlkLEVBWE47QUFZRSxRQUFBLFVBQVUsRUFBRSwwQkFBc0I7QUFBQSxjQUFuQkcsS0FBbUIsUUFBbkJBLEtBQW1CO0FBQUEsY0FBWkMsS0FBWSxRQUFaQSxLQUFZO0FBQ2hDLGNBQU0xRCxJQUFJLEdBQUdQLE9BQU8sQ0FBQ2dFLEtBQUQsQ0FBcEI7O0FBQ0EsY0FBTS9CLFVBQVUsR0FBRyxNQUFJLENBQUNBLFVBQUwsQ0FBZ0IxQixJQUFoQixDQUFuQjs7QUFDQSxpQkFBT2tELFdBQVUsQ0FBQztBQUNoQlMsWUFBQUEsR0FBRyxFQUFFM0QsSUFBSSxDQUFDTSxLQURNO0FBRWhCTSxZQUFBQSxLQUFLLEVBQUVaLElBQUksQ0FBQ1ksS0FGSTtBQUdoQjhDLFlBQUFBLEtBQUssRUFBTEEsS0FIZ0I7QUFJaEJaLFlBQUFBLE1BQU0sRUFBRUcsVUFKUTtBQUtoQjFCLFlBQUFBLFFBQVEsRUFBRTtBQUFBLHFCQUFNLE1BQUksQ0FBQ3FDLFlBQUwsQ0FBa0I1RCxJQUFsQixDQUFOO0FBQUEsYUFMTTtBQU1oQjhCLFlBQUFBLFVBQVUsRUFBRTtBQUFBLHFCQUFNLE1BQUksQ0FBQytCLGNBQUwsQ0FBb0I3RCxJQUFwQixDQUFOO0FBQUEsYUFOSTtBQU9oQjhELFlBQUFBLFlBQVksRUFBRSxDQUFDcEMsVUFBRCxJQUFleUIsYUFQYjtBQVFoQnpCLFlBQUFBLFVBQVUsRUFBVkEsVUFSZ0I7QUFTaEJxQyxZQUFBQSxRQUFRLEVBQUUvRCxJQUFJLENBQUMrRDtBQVRDLFdBQUQsQ0FBakI7QUFXRDtBQTFCSCxTQURGLENBbkJGLENBREY7QUFvREQ7Ozs7RUF0UXNDaEYsYTs7QUFBcEJlLFc7O2dCQUFBQSxXLGVBQ0E7QUFDakJMLEVBQUFBLE9BQU8sRUFBRVQsU0FBUyxDQUFDZ0YsT0FBVixDQUFrQjFFLG1CQUFsQixDQURRO0FBRWpCcUMsRUFBQUEsS0FBSyxFQUFFM0MsU0FBUyxDQUFDaUYsSUFGQTtBQUdqQm5CLEVBQUFBLE1BQU0sRUFBRTlELFNBQVMsQ0FBQ2tGLE1BSEQ7QUFJakJyQixFQUFBQSxLQUFLLEVBQUU3RCxTQUFTLENBQUNrRixNQUpBOztBQU1qQjs7O0FBR0FmLEVBQUFBLGFBQWEsRUFBRW5FLFNBQVMsQ0FBQ21GLElBVFI7O0FBV2pCOzs7QUFHQWxFLEVBQUFBLFFBQVEsRUFBRWpCLFNBQVMsQ0FBQ2dGLE9BQVYsQ0FBa0JoRixTQUFTLENBQUNvRixNQUE1QixDQWRPO0FBZWpCN0MsRUFBQUEsUUFBUSxFQUFFdkMsU0FBUyxDQUFDaUYsSUFmSDtBQWdCakJuQyxFQUFBQSxVQUFVLEVBQUU5QyxTQUFTLENBQUNpRixJQWhCTDtBQWlCakJwQyxFQUFBQSxjQUFjLEVBQUU3QyxTQUFTLENBQUNpRixJQWpCVDtBQWtCakIvQixFQUFBQSxTQUFTLEVBQUVsRCxTQUFTLENBQUNtRixJQWxCSjtBQW1CakJsQixFQUFBQSxVQUFVLEVBQUVqRSxTQUFTLENBQUNrRixNQW5CTDtBQW9CakJoQixFQUFBQSxVQUFVLEVBQUVsRSxTQUFTLENBQUNpRixJQXBCTDtBQXFCakJsQixFQUFBQSxpQkFBaUIsRUFBRS9ELFNBQVMsQ0FBQ29GLE1BckJaO0FBc0JqQnBCLEVBQUFBLFVBQVUsRUFBRWhFLFNBQVMsQ0FBQ29GLE1BdEJMO0FBdUJqQjdELEVBQUFBLGFBQWEsRUFBRXZCLFNBQVMsQ0FBQ2lGLElBdkJSO0FBd0JqQmhDLEVBQUFBLGtCQUFrQixFQUFFakQsU0FBUyxDQUFDb0Y7QUF4QmIsQzs7Z0JBREF0RSxXLGtCQTRCRztBQUNwQkwsRUFBQUEsT0FBTyxFQUFFLEVBRFc7O0FBRXBCOzs7OztBQUtBd0QsRUFBQUEsVUFBVSxFQUFFLEVBUFE7QUFRcEIxQixFQUFBQSxRQUFRLEVBQUUsb0JBQU0sQ0FBRSxDQVJFO0FBU3BCTyxFQUFBQSxVQUFVLEVBQUUsc0JBQU0sQ0FBRSxDQVRBO0FBVXBCRCxFQUFBQSxjQUFjLEVBQUUsMEJBQU0sQ0FBRSxDQVZKO0FBV3BCNUIsRUFBQUEsUUFBUSxFQUFFLEVBWFU7QUFZcEJpRCxFQUFBQSxVQUFVLEVBQUV0RCxZQVpRO0FBYXBCVyxFQUFBQSxhQUFhLEVBQUVmLFdBYks7QUFjcEJ1RCxFQUFBQSxpQkFBaUIsRUFBRSxXQWRDO0FBZXBCQyxFQUFBQSxVQUFVLEVBQUUsUUFmUTtBQWdCcEJmLEVBQUFBLGtCQUFrQixFQUFFO0FBaEJBLEM7O1NBNUJIbkMsVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyBQdXJlQ29tcG9uZW50IH0gZnJvbSAncmVhY3QnXG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnXG5pbXBvcnQgZnV6emFsZHJpbiBmcm9tICdmdXp6YWxkcmluLXBsdXMnXG5pbXBvcnQgVmlydHVhbExpc3QgZnJvbSAncmVhY3QtdGlueS12aXJ0dWFsLWxpc3QnXG5pbXBvcnQgeyBQYW5lIH0gZnJvbSAnLi4vLi4vbGF5ZXJzJ1xuaW1wb3J0IHsgVGFibGVIZWFkLCBTZWFyY2hUYWJsZUhlYWRlckNlbGwgfSBmcm9tICcuLi8uLi90YWJsZSdcbmltcG9ydCBPcHRpb25TaGFwZVByb3BUeXBlIGZyb20gJy4vT3B0aW9uU2hhcGVQcm9wVHlwZSdcbmltcG9ydCBPcHRpb24gZnJvbSAnLi9PcHRpb24nXG5cbi8qKlxuICogRnV6emFsZHJpbi1wbHVzIGlzIHRoZSBkZWZhdWx0IGZpbHRlciwgYnV0IHlvdSBjYW4gdXNlIHlvdXIgb3duXG4gKiBhcyBsb25nIGFzIHRoZXkgZm9sbG93IHRoZSBmb2xsb3dpbmcgc2lnbmF0dXJlOlxuICogQHBhcmFtIG9wdGlvbnMgPEFycmF5W1N0cmluZ10+IC0gWydsYWJlbCcsICdsYWJlbDInLCAuLi5dXG4gKiBAcGFyYW0gaW5wdXQgPFN0cmluZz5cbiAqL1xuY29uc3QgZnV6enlGaWx0ZXIgPSAob3B0aW9ucywgaW5wdXQpID0+IGZ1enphbGRyaW4uZmlsdGVyKG9wdGlvbnMsIGlucHV0KVxuXG4vKipcbiAqIFRoaXMgaXMgdGhlIGRlZmF1bHQgaXRlbSByZW5kZXJlciBvZiBvcHRpb25zXG4gKiB5b3UgY2FuIHBhc3MgY3VzdG9tIHJlbmRlcmVycyBhcyBsb25nIGFzIHRoZXkgd29yayB0aGUgc2FtZSBhcyB0aGUgT3B0aW9uXG4gKi9cbmNvbnN0IGl0ZW1SZW5kZXJlciA9IHByb3BzID0+IDxPcHRpb24gey4uLnByb3BzfSAvPlxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPcHRpb25zTGlzdCBleHRlbmRzIFB1cmVDb21wb25lbnQge1xuICBzdGF0aWMgcHJvcFR5cGVzID0ge1xuICAgIG9wdGlvbnM6IFByb3BUeXBlcy5hcnJheU9mKE9wdGlvblNoYXBlUHJvcFR5cGUpLFxuICAgIGNsb3NlOiBQcm9wVHlwZXMuZnVuYyxcbiAgICBoZWlnaHQ6IFByb3BUeXBlcy5udW1iZXIsXG4gICAgd2lkdGg6IFByb3BUeXBlcy5udW1iZXIsXG5cbiAgICAvKipcbiAgICAgKiBXaGVuIHRydWUsIG11bHRpIHNlbGVjdCBpcyBhY2NvdW50ZWQgZm9yLlxuICAgICAqL1xuICAgIGlzTXVsdGlTZWxlY3Q6IFByb3BUeXBlcy5ib29sLFxuXG4gICAgLyoqXG4gICAgICogVGhpcyBob2xkcyB0aGUgdmFsdWVzIG9mIHRoZSBvcHRpb25zXG4gICAgICovXG4gICAgc2VsZWN0ZWQ6IFByb3BUeXBlcy5hcnJheU9mKFByb3BUeXBlcy5zdHJpbmcpLFxuICAgIG9uU2VsZWN0OiBQcm9wVHlwZXMuZnVuYyxcbiAgICBvbkRlc2VsZWN0OiBQcm9wVHlwZXMuZnVuYyxcbiAgICBvbkZpbHRlckNoYW5nZTogUHJvcFR5cGVzLmZ1bmMsXG4gICAgaGFzRmlsdGVyOiBQcm9wVHlwZXMuYm9vbCxcbiAgICBvcHRpb25TaXplOiBQcm9wVHlwZXMubnVtYmVyLFxuICAgIHJlbmRlckl0ZW06IFByb3BUeXBlcy5mdW5jLFxuICAgIGZpbHRlclBsYWNlaG9sZGVyOiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIGZpbHRlckljb246IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgb3B0aW9uc0ZpbHRlcjogUHJvcFR5cGVzLmZ1bmMsXG4gICAgZGVmYXVsdFNlYXJjaFZhbHVlOiBQcm9wVHlwZXMuc3RyaW5nXG4gIH1cblxuICBzdGF0aWMgZGVmYXVsdFByb3BzID0ge1xuICAgIG9wdGlvbnM6IFtdLFxuICAgIC8qKlxuICAgICAqIEluY2x1ZGluZyBib3JkZXIgYm90dG9tXG4gICAgICogRm9yIHNvbWUgcmVhc29uIHBhc3NpbmcgaGVpZ2h0IHRvIFRhYmxlUm93IGRvZXNuJ3Qgd29ya1xuICAgICAqIFRPRE86IGZpeCBoYWNreSBzb2x1dGlvblxuICAgICAqL1xuICAgIG9wdGlvblNpemU6IDMzLFxuICAgIG9uU2VsZWN0OiAoKSA9PiB7fSxcbiAgICBvbkRlc2VsZWN0OiAoKSA9PiB7fSxcbiAgICBvbkZpbHRlckNoYW5nZTogKCkgPT4ge30sXG4gICAgc2VsZWN0ZWQ6IFtdLFxuICAgIHJlbmRlckl0ZW06IGl0ZW1SZW5kZXJlcixcbiAgICBvcHRpb25zRmlsdGVyOiBmdXp6eUZpbHRlcixcbiAgICBmaWx0ZXJQbGFjZWhvbGRlcjogJ0ZpbHRlci4uLicsXG4gICAgZmlsdGVySWNvbjogJ3NlYXJjaCcsXG4gICAgZGVmYXVsdFNlYXJjaFZhbHVlOiAnJ1xuICB9XG5cbiAgY29uc3RydWN0b3IocHJvcHMsIGNvbnRleHQpIHtcbiAgICBzdXBlcihwcm9wcywgY29udGV4dClcblxuICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICBzZWFyY2hWYWx1ZTogcHJvcHMuZGVmYXVsdFNlYXJjaFZhbHVlLFxuICAgICAgc2VsZWN0ZWQ6IHByb3BzLnNlbGVjdGVkXG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgY29uc3QgeyBoYXNGaWx0ZXIgfSA9IHRoaXMucHJvcHNcbiAgICBpZiAoIWhhc0ZpbHRlcikgcmV0dXJuXG4gICAgLyoqXG4gICAgICogSGFja3kgc29sdXRpb24gZm9yIGJyb2tlbiBhdXRvRm9jdXNcbiAgICAgKiBodHRwczovL2dpdGh1Yi5jb20vc2VnbWVudGlvL2V2ZXJncmVlbi9pc3N1ZXMvOTBcbiAgICAgKi9cbiAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgdGhpcy5zZWFyY2hSZWYucXVlcnlTZWxlY3RvcignaW5wdXQnKS5mb2N1cygpXG4gICAgfSlcblxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgdGhpcy5oYW5kbGVLZXlEb3duKVxuICB9XG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCB0aGlzLmhhbmRsZUtleURvd24pXG4gIH1cblxuICBjb21wb25lbnREaWRVcGRhdGUocHJldlByb3BzKSB7XG4gICAgaWYgKHByZXZQcm9wcy5zZWxlY3RlZCAhPT0gdGhpcy5wcm9wcy5zZWxlY3RlZCkge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlYWN0L25vLWRpZC11cGRhdGUtc2V0LXN0YXRlXG4gICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgc2VsZWN0ZWQ6IHRoaXMucHJvcHMuc2VsZWN0ZWRcbiAgICAgIH0pXG4gICAgfVxuICB9XG5cbiAgaXNTZWxlY3RlZCA9IGl0ZW0gPT4ge1xuICAgIGNvbnN0IHsgc2VsZWN0ZWQgfSA9IHRoaXMuc3RhdGVcblxuICAgIHJldHVybiBCb29sZWFuKHNlbGVjdGVkLmZpbmQoc2VsZWN0ZWRJdGVtID0+IHNlbGVjdGVkSXRlbSA9PT0gaXRlbS52YWx1ZSkpXG4gIH1cblxuICBzZWFyY2ggPSBvcHRpb25zID0+IHtcbiAgICBjb25zdCB7IG9wdGlvbnNGaWx0ZXIgfSA9IHRoaXMucHJvcHNcbiAgICBjb25zdCB7IHNlYXJjaFZhbHVlIH0gPSB0aGlzLnN0YXRlXG5cbiAgICByZXR1cm4gc2VhcmNoVmFsdWUudHJpbSgpID09PSAnJ1xuICAgICAgPyBvcHRpb25zIC8vIFJldHVybiBpZiBubyBzZWFyY2ggcXVlcnlcbiAgICAgIDogb3B0aW9uc0ZpbHRlcihcbiAgICAgICAgICBvcHRpb25zLm1hcChpdGVtID0+IGl0ZW0ubGFiZWxJbkxpc3QgfHwgaXRlbS5sYWJlbCksXG4gICAgICAgICAgc2VhcmNoVmFsdWVcbiAgICAgICAgKS5tYXAobmFtZSA9PlxuICAgICAgICAgIG9wdGlvbnMuZmluZChpdGVtID0+IGl0ZW0ubGFiZWxJbkxpc3QgPT09IG5hbWUgfHwgaXRlbS5sYWJlbCA9PT0gbmFtZSlcbiAgICAgICAgKVxuICB9XG5cbiAgZ2V0Q3VycmVudEluZGV4ID0gKCkgPT4ge1xuICAgIGNvbnN0IHsgc2VsZWN0ZWQgfSA9IHRoaXMucHJvcHNcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5nZXRGaWx0ZXJlZE9wdGlvbnMoKVxuXG4gICAgcmV0dXJuIG9wdGlvbnMuZmluZEluZGV4KFxuICAgICAgb3B0aW9uID0+IG9wdGlvbi52YWx1ZSA9PT0gc2VsZWN0ZWRbc2VsZWN0ZWQubGVuZ3RoIC0gMV1cbiAgICApXG4gIH1cblxuICBnZXRGaWx0ZXJlZE9wdGlvbnMoKSB7XG4gICAgY29uc3QgeyBvcHRpb25zIH0gPSB0aGlzLnByb3BzXG5cbiAgICByZXR1cm4gdGhpcy5zZWFyY2gob3B0aW9ucylcbiAgfVxuXG4gIGhhbmRsZUtleURvd24gPSBlID0+IHtcbiAgICBpZiAoZS5rZXlDb2RlID09PSAzOCkge1xuICAgICAgdGhpcy5oYW5kbGVBcnJvd1VwKClcbiAgICB9XG5cbiAgICBpZiAoZS5rZXlDb2RlID09PSA0MCkge1xuICAgICAgdGhpcy5oYW5kbGVBcnJvd0Rvd24oKVxuICAgIH1cblxuICAgIGlmIChlLmtleUNvZGUgPT09IDEzKSB7XG4gICAgICB0aGlzLmhhbmRsZUVudGVyKClcbiAgICB9XG4gIH1cblxuICBoYW5kbGVBcnJvd1VwID0gKCkgPT4ge1xuICAgIGNvbnN0IHsgb25TZWxlY3QgfSA9IHRoaXMucHJvcHNcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5nZXRGaWx0ZXJlZE9wdGlvbnMoKVxuXG4gICAgbGV0IG5leHRJbmRleCA9IHRoaXMuZ2V0Q3VycmVudEluZGV4KCkgLSAxXG5cbiAgICBpZiAobmV4dEluZGV4IDwgMCkge1xuICAgICAgbmV4dEluZGV4ID0gb3B0aW9ucy5sZW5ndGggLSAxXG4gICAgfVxuXG4gICAgb25TZWxlY3Qob3B0aW9uc1tuZXh0SW5kZXhdKVxuICB9XG5cbiAgaGFuZGxlQXJyb3dEb3duID0gKCkgPT4ge1xuICAgIGNvbnN0IHsgb25TZWxlY3QgfSA9IHRoaXMucHJvcHNcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5nZXRGaWx0ZXJlZE9wdGlvbnMoKVxuXG4gICAgbGV0IG5leHRJbmRleCA9IHRoaXMuZ2V0Q3VycmVudEluZGV4KCkgKyAxXG5cbiAgICBpZiAobmV4dEluZGV4ID09PSBvcHRpb25zLmxlbmd0aCkge1xuICAgICAgbmV4dEluZGV4ID0gMFxuICAgIH1cblxuICAgIG9uU2VsZWN0KG9wdGlvbnNbbmV4dEluZGV4XSlcbiAgfVxuXG4gIGhhbmRsZUVudGVyID0gKCkgPT4ge1xuICAgIGNvbnN0IGlzU2VsZWN0ZWQgPSB0aGlzLmdldEN1cnJlbnRJbmRleCgpICE9PSAtMVxuXG4gICAgaWYgKGlzU2VsZWN0ZWQpIHtcbiAgICAgIHRoaXMucHJvcHMuY2xvc2UoKVxuICAgIH1cbiAgfVxuXG4gIGhhbmRsZUNoYW5nZSA9IHNlYXJjaFZhbHVlID0+IHtcbiAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgIHNlYXJjaFZhbHVlXG4gICAgfSlcbiAgICB0aGlzLnByb3BzLm9uRmlsdGVyQ2hhbmdlKHNlYXJjaFZhbHVlKVxuICB9XG5cbiAgaGFuZGxlU2VsZWN0ID0gaXRlbSA9PiB7XG4gICAgdGhpcy5wcm9wcy5vblNlbGVjdChpdGVtKVxuICB9XG5cbiAgaGFuZGxlRGVzZWxlY3QgPSBpdGVtID0+IHtcbiAgICB0aGlzLnByb3BzLm9uRGVzZWxlY3QoaXRlbSlcbiAgfVxuXG4gIGFzc2lnblNlYXJjaFJlZiA9IHJlZiA9PiB7XG4gICAgdGhpcy5zZWFyY2hSZWYgPSByZWZcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7XG4gICAgICBvcHRpb25zOiBvcmlnaW5hbE9wdGlvbnMsXG4gICAgICBjbG9zZSxcbiAgICAgIHdpZHRoLFxuICAgICAgaGVpZ2h0LFxuICAgICAgb25TZWxlY3QsXG4gICAgICBvbkRlc2VsZWN0LFxuICAgICAgb25GaWx0ZXJDaGFuZ2UsXG4gICAgICBzZWxlY3RlZCxcbiAgICAgIGhhc0ZpbHRlcixcbiAgICAgIGZpbHRlclBsYWNlaG9sZGVyLFxuICAgICAgZmlsdGVySWNvbixcbiAgICAgIG9wdGlvblNpemUsXG4gICAgICByZW5kZXJJdGVtLFxuICAgICAgb3B0aW9uc0ZpbHRlcixcbiAgICAgIGlzTXVsdGlTZWxlY3QsXG4gICAgICBkZWZhdWx0U2VhcmNoVmFsdWUsXG4gICAgICAuLi5wcm9wc1xuICAgIH0gPSB0aGlzLnByb3BzXG4gICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMuc2VhcmNoKG9yaWdpbmFsT3B0aW9ucylcbiAgICBjb25zdCBsaXN0SGVpZ2h0ID0gaGVpZ2h0IC0gKGhhc0ZpbHRlciA/IDMyIDogMClcbiAgICBjb25zdCBjdXJyZW50SW5kZXggPSB0aGlzLmdldEN1cnJlbnRJbmRleCgpXG4gICAgY29uc3Qgc2Nyb2xsVG9JbmRleCA9IGN1cnJlbnRJbmRleCA9PT0gLTEgPyAwIDogY3VycmVudEluZGV4XG5cbiAgICByZXR1cm4gKFxuICAgICAgPFBhbmVcbiAgICAgICAgaGVpZ2h0PXtoZWlnaHR9XG4gICAgICAgIHdpZHRoPXt3aWR0aH1cbiAgICAgICAgZGlzcGxheT1cImZsZXhcIlxuICAgICAgICBmbGV4RGlyZWN0aW9uPVwiY29sdW1uXCJcbiAgICAgICAgey4uLnByb3BzfVxuICAgICAgPlxuICAgICAgICB7aGFzRmlsdGVyICYmIChcbiAgICAgICAgICA8VGFibGVIZWFkPlxuICAgICAgICAgICAgPFNlYXJjaFRhYmxlSGVhZGVyQ2VsbFxuICAgICAgICAgICAgICBvbkNoYW5nZT17dGhpcy5oYW5kbGVDaGFuZ2V9XG4gICAgICAgICAgICAgIGlubmVyUmVmPXt0aGlzLmFzc2lnblNlYXJjaFJlZn1cbiAgICAgICAgICAgICAgYm9yZGVyUmlnaHQ9e251bGx9XG4gICAgICAgICAgICAgIGhlaWdodD17MzJ9XG4gICAgICAgICAgICAgIHBsYWNlaG9sZGVyPXtmaWx0ZXJQbGFjZWhvbGRlcn1cbiAgICAgICAgICAgICAgaWNvbj17ZmlsdGVySWNvbn1cbiAgICAgICAgICAgIC8+XG4gICAgICAgICAgPC9UYWJsZUhlYWQ+XG4gICAgICAgICl9XG4gICAgICAgIDxQYW5lIGZsZXg9ezF9PlxuICAgICAgICAgIDxWaXJ0dWFsTGlzdFxuICAgICAgICAgICAgaGVpZ2h0PXtsaXN0SGVpZ2h0fVxuICAgICAgICAgICAgd2lkdGg9XCIxMDAlXCJcbiAgICAgICAgICAgIGl0ZW1TaXplPXtvcHRpb25TaXplfVxuICAgICAgICAgICAgaXRlbUNvdW50PXtvcHRpb25zLmxlbmd0aH1cbiAgICAgICAgICAgIG92ZXJzY2FuQ291bnQ9ezIwfVxuICAgICAgICAgICAgc2Nyb2xsVG9BbGlnbm1lbnQ9XCJhdXRvXCJcbiAgICAgICAgICAgIHsuLi4oc2Nyb2xsVG9JbmRleFxuICAgICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICAgIHNjcm9sbFRvSW5kZXhcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIDoge30pfVxuICAgICAgICAgICAgcmVuZGVySXRlbT17KHsgaW5kZXgsIHN0eWxlIH0pID0+IHtcbiAgICAgICAgICAgICAgY29uc3QgaXRlbSA9IG9wdGlvbnNbaW5kZXhdXG4gICAgICAgICAgICAgIGNvbnN0IGlzU2VsZWN0ZWQgPSB0aGlzLmlzU2VsZWN0ZWQoaXRlbSlcbiAgICAgICAgICAgICAgcmV0dXJuIHJlbmRlckl0ZW0oe1xuICAgICAgICAgICAgICAgIGtleTogaXRlbS52YWx1ZSxcbiAgICAgICAgICAgICAgICBsYWJlbDogaXRlbS5sYWJlbCxcbiAgICAgICAgICAgICAgICBzdHlsZSxcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IG9wdGlvblNpemUsXG4gICAgICAgICAgICAgICAgb25TZWxlY3Q6ICgpID0+IHRoaXMuaGFuZGxlU2VsZWN0KGl0ZW0pLFxuICAgICAgICAgICAgICAgIG9uRGVzZWxlY3Q6ICgpID0+IHRoaXMuaGFuZGxlRGVzZWxlY3QoaXRlbSksXG4gICAgICAgICAgICAgICAgaXNTZWxlY3RhYmxlOiAhaXNTZWxlY3RlZCB8fCBpc011bHRpU2VsZWN0LFxuICAgICAgICAgICAgICAgIGlzU2VsZWN0ZWQsXG4gICAgICAgICAgICAgICAgZGlzYWJsZWQ6IGl0ZW0uZGlzYWJsZWRcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH19XG4gICAgICAgICAgLz5cbiAgICAgICAgPC9QYW5lPlxuICAgICAgPC9QYW5lPlxuICAgIClcbiAgfVxufVxuIl19